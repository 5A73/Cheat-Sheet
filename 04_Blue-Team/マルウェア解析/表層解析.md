# マルウェア解析における手法とツール

## ファイル形式の特定（実行環境OS／アーキテクチャ）
ファイルのヘッダに書き込まれている**マジックナンバー／シグネチャ（ファイルシグネチャ）**を解析することで、ファイルの実行環境OSやアーキテクチャを特定します。

---

## ハッシュ値の取得
ファイル全体をハッシュ関数を用いてハッシュ値を取得します。得られたハッシュ値は以下のような目的で活用されます：
- ソフトウェアやツールへの情報展開が容易になる。
- オンライン上でインジケータを用いて有益な情報を検索するキーワードとなる。

---

## 類似性を用いた解析
現実的には、マルウェアのインジケータ部分が日々変化するため、**ハッシュ値をインジケータとして有効活用できるライフタイムは短い**です。そのため、類似性を定量的に算出する解析手法が重要となります。

### 主な手法
- **ファジーハッシュ（Fuzzy Hashing）**  
  コンテンツ内のデータを対象に類似度を算出します。類似度が高いほど算出されたハッシュ値の文字や文字の並びが近くなります。ファジーハッシュは概念であり、具体的な手法はツールにより異なります。

- **インポートハッシュ（Import Hash）**  
  PEファイルのインポート関数とその順序性からハッシュ値を算出します。同一のマルウェアで接続先などのみが変化している場合、類似性算出に有効です。ただし、機能追加が行われた場合にはハッシュ値が異なる特性があります。

- **セクションハッシュ（Section Hash）**  
  PEヘッダ内の各セクションを対象にハッシュ値を算出する手法です。

- **impfuzzy**  
  インポート関数のテーブルを対象にファジーハッシュを用いて類似度を算出する手法です。機能追加や一部変更にも対応可能で、マルウェアファミリーや亜種の判別に役立ちます。

---

## 文字列の抽出
プログラムの動作に関する文字列やインジケータとなる情報を取得します。ASCIIだけでなく**Unicode**を利用している場合が多いため、両方を対象にデータを取得する必要があります。

- **FLOSS (FireEye Labs Obfuscated String Solver)**  
  難読化された文字列を容易にデコードし、結果を確認できるツールです。

---

## 難読化対策
多くのマルウェアは解析を妨害する目的で難読化されています。難読化されたファイルをデコードするためには、難読化の種類を特定し適切な手段を選択する必要があります。

### 主な難読化手法
1. **パッカー**  
   プログラムを圧縮することでコンテンツを難読化します。パッキングされたプログラムには解凍モジュールが同梱されており、メモリ上でコンテンツを展開して元の実行形式に復元します。
   - 例: UPX形式

2. **クリプター**  
   コンテンツを暗号化して難読化を行います。暗号化されたプログラムには復号モジュールが同梱されており、メモリ上で復号されたコンテンツを展開して元の実行形式に復元します。

- **Exeinfo PE**  
  難読化方式を容易に検出できるツールです。

---

## PE解析
**PE（Portable Executable）ファイル形式**は、Windowsの実行ファイル形式です。コンパイル時にヘッダ領域に参照ライブラリや関数、リソースなどの情報が記載されるため、以下のような解析が可能です：
- プログラムの挙動に関する重要な情報をヘッダから取得。
- 呼び出すAPIの数が極端に少ない場合は難読化の可能性を示唆。

また、**リソース領域**にはプログラムに内蔵された別のファイルが含まれている場合があります。
- **Resource Hacker**  
  内蔵ファイルを抽出するためのツールです。