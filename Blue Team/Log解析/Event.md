# Windowsでのログ解析のやり方

Windows環境でのログ解析には、システムログやアプリケーションログ、セキュリティログなど、さまざまな種類のログが含まれます。以下に、Windowsでのログ解析の基本的な手順と方法を詳しく説明します。

## 目次
1. [ログの収集](#ログの収集)
2. [イベントビューアの使用](#イベントビューアの使用)
3. [PowerShellによるログの解析](#powershellによるログの解析)
4. [サードパーティツールの利用](#サードパーティツールの利用)
5. [アラートと監視の設定](#アラートと監視の設定)

## ログの収集

Windowsのログは主にイベントログとして保存され、システム、アプリケーション、セキュリティなどのカテゴリに分かれています。

### 主なログの種類
- **システムログ**: Windowsのシステムイベントに関するログ（例：システムの起動、シャットダウン）。
- **アプリケーションログ**: アプリケーションのエラーやイベントに関するログ。
- **セキュリティログ**: セキュリティ関連のイベント（例：ログイン試行、アクセス制御）。

### ログの収集方法
- **イベントビューア**: Windowsに標準で搭載されているツールで、ログの表示や保存ができます。
- **コマンドラインツール**: `wevtutil`や`eventquery`を使用してログをコマンドラインから操作できます。

## イベントビューアの使用

イベントビューアは、Windowsの標準ツールで、ログの表示、フィルタリング、エクスポートができます。

### イベントビューアの起動
1. **スタートメニュー**を開き、**「イベントビューア」**を検索して起動します。

### ログの表示とフィルタリング
1. 左側のペインでログカテゴリ（例：**「Windowsログ」** > **「システム」**）を選択します。
2. 中央のペインに表示されたログを確認し、必要に応じて**「アクション」**メニューから**「フィルタ」**を選択して、特定のイベントや期間でフィルタリングします。

インシデントでよく発生するログとイベントID

1. ログオンおよびログオフ関連のイベント

	•	イベントID 4624: 成功したログオン
ユーザーがシステムにログオンした際に記録されます。ログオンの種類やログオン元などの情報を含みます。
	•	イベントID 4625: 失敗したログオン
認証に失敗したログオン試行を記録します。失敗の理由（無効なパスワードなど）が含まれます。
	•	イベントID 4634: ログオフ
ユーザーがログオフした際のイベントです。
	•	イベントID 4647: ユーザーのログオフ
ユーザーが手動でログオフした場合のイベントです。

2. プロセス作成および終了関連のイベント

	•	イベントID 4688: プロセスの作成
新しいプロセスが作成された際の詳細情報を記録します。プロセス名やコマンドライン引数などが含まれます。
	•	イベントID 4689: プロセスの終了
プロセスが終了した際のイベントです。プロセスIDと終了コードが含まれます。

3. 権限昇格関連のイベント

	•	イベントID 4672: 特権のあるログオン
ユーザーが特権のあるログオン（管理者権限など）を行った際のイベントです。
	•	イベントID 4688: プロセスの作成
特権昇格を伴うプロセスの作成も記録されます。特に、powershell.exeやcmd.exeの起動が関連することがあります。

4. ネットワーク接続関連のイベント

	•	イベントID 5156: Windowsフィルタードライバの接続
ネットワーク接続の許可や拒否に関する情報を記録します。接続元IPアドレスやポート番号などが含まれます。
	•	イベントID 5158: Windowsフィルタードライバの接続許可
特定のネットワーク接続が許可された場合のイベントです。

5. セキュリティ設定およびポリシーの変更

	•	イベントID 4732: グループメンバーシップの変更
グループメンバーシップの変更（ユーザーが特定のグループに追加された場合など）を記録します。
	•	イベントID 4733: グループメンバーシップの削除
グループからユーザーが削除された際のイベントです。

6. ファイルやレジストリの変更

	•	イベントID 4663: オブジェクトのアクセス
ファイルやレジストリキーへのアクセス（読み取り、書き込み）が記録されます。特に重要なファイルやレジストリキーへのアクセスが含まれます。

7. Sysmonログ

	•	イベントID 1: プロセス作成
Sysmonがプロセス作成を記録します。プロセスの詳細（実行パス、コマンドライン引数など）が含まれます。
	•	イベントID 3: ネットワーク接続
Sysmonがネットワーク接続を記録します。接続元IPアドレス、ポート番号などの情報が含まれます。
	•	イベントID 7: プロセス終了
Sysmonがプロセスの終了を記録します。プロセスIDと終了コードが含まれます。

8. PowerShellログ

	•	イベントID 4103: PowerShellスクリプトの実行
PowerShellスクリプトが実行された際の情報が記録されます。
	•	イベントID 4104: PowerShellコマンドの実行
PowerShellコマンドが実行された際の情報を記録します。コマンドライン引数などが含まれます。


### ログのエクスポート
1. イベントビューアでエクスポートしたいログを選択します。
2. **「アクション」**メニューから**「すべてのイベントを保存」**を選択し、ファイル形式（例：CSV、EVTX）を選んで保存します。

## PowerShellによるログの解析

PowerShellを使用することで、ログの自動化された解析やフィルタリングが可能です。

### 主なコマンド
- **`Get-EventLog`**: ログを取得し表示します。
- **`Get-WinEvent`**: より詳細なログ取得が可能で、複数のソースからのログを検索できます。

### 例
```powershell
# システムログの最新100件を取得
Get-EventLog -LogName System -Newest 100

# 特定のイベントIDを持つログを取得
Get-EventLog -LogName Security -InstanceId 4624

# イベントの詳細情報を取得
Get-WinEvent -LogName Application | Format-List
```

## サードパーティツールの利用

より高度なログ解析や視覚化には、サードパーティツールを使用することができます。

### 代表的なツール
- **Splunk**: 高度なログ解析とダッシュボード機能を提供するツール。
- **LogRhythm**: セキュリティイベント管理とログ解析に特化したツール。
- **ELK Stack (Elasticsearch, Logstash, Kibana)**: オープンソースのログ収集、解析、可視化ツールのセット。

## アラートと監視の設定

ログ監視とアラートの設定により、リアルタイムでの異常検出と対応が可能です。

### 方法
- **タスクスケジューラ**: 定期的なスクリプト実行やアクションの設定が可能です。
- **監視ツール**: SplunkやELK Stackなどを用いて、リアルタイムでの監視とアラートの設定を行います。

### 例
```powershell
# イベントログの監視を設定するPowerShellスクリプト
$filter = @"
*[System[(EventID=4624)]]
"@
Register-WmiEvent -Query "SELECT * FROM __InstanceCreationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_NTLogEvent' AND $filter" -Action {
    $event = $Event.SourceEventArgs.NewEvent.TargetInstance
    Write-Host "ログインイベント発生: $($event.InsertionStrings)"
}
```

## まとめ

Windows環境でのログ解析は、イベントビューア、PowerShell、サードパーティツールを活用することで効率的に実施できます。ログの収集から解析、アラート設定までを適切に行うことで、システムの健全性を維持し、セキュリティインシデントに迅速に対応することが可能です。