以下に、インシデント発生時にインシデントレスポンスチーム（IRT）がWindowsのイベントビューアとSplunkを使用して調査する方法を詳しく説明します。これには、各ツールの使用方法と調査手順が含まれます。

---
目次

### 1. [Windowsイベントビューアを使用した調査](#Windowsイベントビューアを使用した調査)
- 1.1 イベントビューアの起動
- 1.2 ログの検索
  - [インシデント発生時に調査すべきイベントIDリスト](#インシデント発生時に調査すべきイベントIDリスト)
- 1.3 検索結果の分析
- 1.4 ログの保存
### 2. [Splunkを使用した調査](#Splunkを使用した調査)
- 2.1 Splunkのダッシュボードにアクセス
- 2.2 データの検索
- 2.3 ダッシュボードと視覚化の使用
- 2.4 アラートの設定
- 2.5 検索結果の保存と共有

## インシデント発生時の調査手順

### 1. **Windowsイベントビューアを使用した調査**

#### 1.1 **イベントビューアの起動**

1. **スタートメニュー**を開き、「**イベントビューア**」と入力し、**イベントビューア**を選択します。

#### 1.2 **ログの検索**

1. **Windowsログ**を展開し、以下のログを確認します。

   - **セキュリティ**: ユーザーのログオン、ログオフ、権限昇格、アカウントのロックアウトなど
   - **アプリケーション**: アプリケーションエラーや警告
   - **システム**: システムエラーや警告
   - **カスタムビュー**: 特定のカスタムビューが設定されている場合

2. **フィルタリング**:
   - **アクションペイン**から「**現在のログのフィルター**」をクリックします。
   - **イベントID**や**日付と時刻**、**ユーザー名**などの条件を指定します。

   **例**: 失敗したログオン試行を検索する場合

   ```plaintext
   Event ID: 4625
   ```

   **例**: 特定の時間範囲でのプロセス作成イベントを検索する場合

   ```plaintext
   Event ID: 4688
   Time Range: 2024-08-20 00:00:00 to 2024-08-21 00:00:00
   ```

### インシデント発生時の調査に役立つイベントIDリスト

ログオンおよびログオフ関連

- 4624: 成功したログオン
- 4625: 失敗したログオン
- 4634: ログオフ
- 4647: ユーザーのログオフ

プロセス作成および終了

- 4688: プロセスの作成
- 4689: プロセスの終了

権限昇格

- 4672: 特権のあるログオン

ネットワーク接続

- 5156: Windowsフィルタードライバの接続
- 5158: Windowsフィルタードライバの接続許可

セキュリティ設定およびポリシー変更

- 4732: グループメンバーシップの変更
- 4733: グループメンバーシップの削除
- 4719: セキュリティポリシーの変更

ファイルやレジストリの変更

- 4663: オブジェクトのアクセス

Sysmonログ

- 1: プロセス作成
- 3: ネットワーク接続
- 7: プロセス終了

PowerShellログ

- 4103: PowerShellスクリプトの実行
- 4104: PowerShellコマンドの実行

アカウント管理

- 4720: アカウントの作成
- 4722: アカウントの有効化
- 4723: アカウントのパスワード変更試行
- 4724: アカウントのパスワードリセット
- 4725: アカウントの無効化
- 4726: アカウントの削除

リモートデスクトップおよびサービス

- 4648: 特権のあるログオン（リモートデスクトップセッションなど）
- 4776: NTLM認証の失敗
- 4800: コンピュータのロック
- 4801: コンピュータのロック解除

システムイベント

- 6005: イベントログサービスの起動
- 6006: イベントログサービスの停止
- 6008: 不正なシャットダウン

Windows Defender

- 1116: Windows Defenderのスキャン結果
- 2001: Windows Defenderのスキャンエラー

ネットワークおよびサービス

- 7045: サービスのインストール
- 7040: サービスの状態変更

3. **検索結果の分析**:
   - イベントの詳細を確認し、どのユーザーがどのアクションを行ったのか、またはエラーや警告の原因を分析します。

4. **ログの保存**:
   - **アクションペイン**から「**すべてのイベントを保存**」を選択し、CSVやXML形式でエクスポートします。

### 2. **Splunkを使用した調査**

#### 2.1 **Splunkのダッシュボードにアクセス**

1. **Webブラウザ**でSplunkのダッシュボードにアクセスします。

   - **URL**: `http://<Splunk_IP>:8000`

2. **ログイン**:
   - デフォルトのユーザー名とパスワードでログインします。

#### 2.2 **データの検索**

1. **検索バー**を使用して、特定のログデータを検索します。

   **例**: 失敗したログオン試行を検索する場合

   ```spl
   index=wineventlog sourcetype=WinEventLog:Security EventCode=4625
   ```

   **例**: 特定のユーザー（例: `admin`）によるプロセス作成イベントを検索

   ```spl
   index=wineventlog sourcetype=WinEventLog:Security EventCode=4688 user=admin
   ```

2. **フィルタリングとクエリのカスタマイズ**:
   - 検索結果をさらに絞り込むために、**時間範囲**や**ホスト名**、**イベントID**などでフィルタリングします。
   
   **例**: 特定の時間範囲でのイベントを検索

   ```spl
   index=wineventlog sourcetype=WinEventLog:Security EventCode=4688 earliest="2024-08-20T00:00:00" latest="2024-08-21T00:00:00"
   ```

3. **ダッシュボードと視覚化の使用**:
   - **ダッシュボード**で、検索結果を視覚化して分析します。グラフやチャートを作成し、パターンやトレンドを確認します。

4. **アラートの設定**:
   - 必要に応じて、**アラート**を設定し、特定の条件を満たすイベントが発生した際に通知を受け取るようにします。

   **例**: 失敗したログオン試行が一定数を超えた場合にアラートを設定

   ```spl
   index=wineventlog sourcetype=WinEventLog:Security EventCode=4625 | stats count by user | where count > 5
   ```

5. **検索結果の保存と共有**:
   - **検索結果**を保存し、**レポート**や**ダッシュボード**として共有します。

   **例**: 検索結果をレポートとして保存する

   ```spl
   Save As > Report
   ```

### 参考資料

- [Windowsイベントログの公式ドキュメント](https://docs.microsoft.com/ja-jp/windows/security/threat-protection/auditing/)
- [Splunkの公式ドキュメント - 基本検索](https://docs.splunk.com/Documentation/Splunk/latest/Search/Aboutsearches)
- [Splunkの公式ドキュメント - ダッシュボードの作成](https://docs.splunk.com/Documentation/Splunk/latest/Viz/Dashboards)

---

このガイドを使って、インシデント発生時にWindowsイベントビューアとSplunkの両方で詳細な調査を行い、効果的に問題を特定し対応することができます。
