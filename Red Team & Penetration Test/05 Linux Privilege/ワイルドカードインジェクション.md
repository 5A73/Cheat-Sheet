
# ワイルドカードを悪用した権限昇格

## 目次
- [概要](#概要)
- [シナリオ](#シナリオ)
- [ワイルドカードインジェクションの発生原理](#ワイルドカードインジェクションの発生原理)
  - [Case1: rmコマンドの使用例](#case1-rmコマンドの使用例)
  - [Case2: rmコマンドでのインジェクション例](#case2-rmコマンドでのインジェクション例)
- [ワイルドカードインジェクションで悪用可能なコマンド](#ワイルドカードインジェクションで悪用可能なコマンド)
- [対策](#対策)
- [まとめ](#まとめ)

## 概要
ワイルドカードは複数のファイルやディレクトリを操作する際に使用しますが、使い方によっては攻撃者が侵入したLinuxマシン上で、権限昇格に悪用される可能性があります。ここでは、アーカイブファイルを作成／展開するLinuxコマンドである`tar`を例に、一般ユーザからrootユーザへ権限昇格が成功する様子を見ていきます。

## シナリオ
攻撃者はWebアプリケーションを実行しているLinuxマシンへの侵入に成功し、`www-data`ユーザの権限でシェルを操作可能です。攻撃者は権限昇格を目指しLinuxマシンの内部を探索した結果、root権限で定期的にWebのコンテンツをバックアップしている設定を発見しました。具体的な設定は以下の通りです。

- `cron`により`/opt/backup.sh`がroot権限で定期実行されている。
- `/opt/backup.sh`は、`/var/www/html`配下のデータをアーカイブファイルとして`/var/backups/webcontents_backup.tar`に保存するスクリプト。
- `www-data`ユーザは、`/opt/backup.sh`への書き込み権限はない。

攻撃者は、`/var/www/html`配下に攻撃者の持つマシンへリバースシェルを接続するコマンドを記載した`shell.sh`を配置します。また、同ディレクトリ配下に以下の名前を持つファイルを作成します。

- `--checkpoint=1`
- `--checkpoint-action=exec=sh shell.sh`

この状態で、`/opt/backup.sh`がcronで定期実行されるまで一定時間待機すると、侵入したLinuxマシンから攻撃者の持つマシンへリバースシェルが確立されます。`id`コマンドの実行結果の通り、このシェルはroot権限のシェルであり、`www-data`ユーザからrootユーザへの権限昇格に成功していることが確認できます。

## ワイルドカードインジェクションの発生原理
Linuxシェルでワイルドカードを使用した場合、シェルはハイフン（`-`）で始まるファイルやディレクトリをコマンドラインの引数として解釈します。これがワイルドカードインジェクションの発生原理であり、シェルの「展開」という処理によるものです。

### Case1: rmコマンドの使用例
`wild`ディレクトリ配下に1つのディレクトリ（`dir`）と3つのファイル（`file1.txt`、`file2.txt`、`file3.txt`）があり、これを初期状態とします。これらをまとめて削除するために`rm`コマンドの引数に`*`を指定して実行します。

```bash
rm *
```

結果、3つのファイルは削除できましたが、`dir`ディレクトリは削除できず残ったままです。

### Case2: rmコマンドでのインジェクション例
Case1の初期状態からさらに、`-r`という名前のファイルを作成し、同様に`rm`コマンドの引数に`*`を指定して実行します。

```bash
rm *
```

`-r`ファイルが存在している状態で`rm`コマンドを実行すると、`dir`ディレクトリが削除され、`-r`という名前のファイルは残ります。

`rm`コマンド実行時、シェルによって`-r`が`rm`コマンドのオプションとして解釈されたため、`dir`ディレクトリが削除されました。

## ワイルドカードインジェクションで悪用可能なコマンド
ワイルドカードインジェクションで悪用される可能性があるコマンドには以下のものがあります。

| コマンド | コマンドオプション | 悪用された際に想定される影響 |
|----------|---------------------|-------------------------------|
| `chown`  | `--reference=FILE`  | ファイルやディレクトリの所有者を任意のユーザ、グループに変更 |
| `chmod`  | `--reference=FILE`  | ファイルやディレクトリのパーミッションを任意の設定に変更 |
| `rsync`  | `--rsh=COMMAND`, `--rsync-path=PROGRAM` | 任意コマンドの実行 |

## 対策
ワイルドカードインジェクションの対策としては、引数に指定したワイルドカードの前にフルパスを指定することが有効です。

例えば、`rm`コマンド実行時にワイルドカードの前にフルパスを指定することで、`-r`が`rm`コマンドのオプションではなく、ファイルとして認識されます。

```bash
rm /path/to/files/*
```

同様に、`/opt/backup.sh`の4行目を以下のように書き換えることで、ワイルドカードインジェクションを防ぐことが可能です。

```bash
tar cvf /var/backups/webcontents_backup.tar /var/www/html/*
```

## まとめ
ワイルドカードインジェクションの概要、発生原理、および対策について紹介しました。ワイルドカードの使用は便利ですが、潜在的な危険性があることを認識しておくことが重要です。興味を持たれた方は、`chown`、`chmod`、`rsync`での悪用方法についてもご自身で動作確認してみてください。
